<html><head><meta content="text/html; charset=utf-8" http-equiv="content-type" /><script type="text/x-mathjax-config">/* Fix org-generated pictures to MathJX. Big thanks to Davide Cervone
  on StackOverflow with this. http://stackoverflow.com/a/14631703/308668
  */
MathJax.Extension.myImg2jax = {
    version: "1.0",
    PreProcess: function (element) {
        var images = element.getElementsByTagName("img");
        for (var i = images.length - 1; i >= 0; i--) {
            var img = images[i];
            if (img.className === "dvipng") {
                var script = document.createElement("script");
                script.type = "math/tex";
                var match = img.alt.match(/^(\$\$?)(.*)\1/);
                if (match[1] === "$$") {script.type += ";mode=display"}
                MathJax.HTML.setScript(script,match[2]);
                img.parentNode.replaceChild(script,img);
            }
        }
    }
};
MathJax.Hub.Register.PreProcessor(["PreProcess",MathJax.Extension.myImg2jax]);
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script><link href="http://fwwm.us/css/main.css" rel="stylesheet" type="text/css" /><title>Xmonad ja dynaamiset työpöydät - Life at the Room.</title><link href="http://fwwm.us/css/miete.css" rel="stylesheet" type="text/css" /></head><body><div id="sidebar-left"><div id="post-info"><div id="navi"><span class="title">Navigointi</span><ul id="navi-list"><li class="fp"><a href="http://fwwm.us/">Etusivulle</a></li><li><a href="http://fwwm.us/miete/index.html">Mietteet</a></li><li><a href="..">marraskuu</a></li><li><a href="../..">2013</a></li></ul></div><span class="title">Info</span><p class="date">Julkaistu<br />14.11.2013 12:53</p></div><div id="post-tags"><span class="title">Tagit</span><ul id="tags-list"><li><div class="taggy"><div class="taggy-inner"><a href="http://fwwm.us/tag/xmonad/index.html">xmonad</a></div></div></li><li><div class="taggy"><div class="taggy-inner"><a href="http://fwwm.us/tag/haskell/index.html">haskell</a></div></div></li></ul></div></div><div id="content"><div class="post-content">
<h1>Xmonad ja dynaamiset työpöydät    </h1>
<div id="text-2-13" class="outline-text-3">




<p>
   Xmonadin oletuksena tarjoamat 9-10 työpöytää tulevat nopeasti
   ahtaaksi, kun oikein haluaa railatella. Lisäksi ennalta valitut,
   kiinnitetyt työpöytänimet eivät aina kuvaa koko totuutta.
   Saataisiinko Emacsin <a href="http://www.emacswiki.org/emacs/InteractivelyDoThings">IDO</a>-moodia vastaavaa huippukäytettävää
   toiminnallisuutta Xmonadin työpöytiinkin? Voi, kyllä saadaan,
   kiitos tuoreen löydön, <a href="http://xmonad.org/xmonad-docs/xmonad-contrib/XMonad-Actions-Commands.html">Xmonad.Actions.Commands</a>-kirjaston.
</p>
<p>
   Tuli tässä virikettä säätää Xmonadia eteenpäin, kun kuulin
   tyylikkäästä <a href="http://xmonad.org/xmonad-docs/xmonad-contrib/XMonad-Actions-Commands.html">X.A.Commands</a>-kirjastosta. Kyseinen kirjasto tarjoaa
   <a href="http://tools.suckless.org/dmenu/">dmenu</a>-rajapinnan erilaisten Xmonad-komentojen (eli tietyntyyppisten
   Haskell-funktioiden) suorittamiseen. Dmenulle tarjoillaan lista
   erilaisia merkkijonoja ja käyttäjä valkkaa sopivan listalta. Xmonad
   suorittaa sitten. Suurin ilo irtoaa sitten, kun muistaa erään
   <a href="http://lists.suckless.org/dev/1209/12505.html">sumean haun toiminnallisuuden tuovan pätsin</a> olemassaolon dmenun
   versiolle 4.5.
</p>

</div>

<div class="outline-4" id="outline-container-2-13-1">
<h2>Dmenu 4.5 ja <code>dmenu-4.5-fuzzy.diff</code></h2>
<div id="text-2-13-1" class="outline-text-4">


<p>
    Tavallinen dmenu ottaa listan merkkijonoja vastaan, esittää ne
    graafisena listalla näytön ylä- tai alareunassa, ja antaa
    käyttäjän näppäillä listaa lyhyemmäksi, kunnes voi valita
    mieleisensä näppäimistöltä käsin. Dmenu palauttaa valinnan
    <i>stdouttiin</i>.
</p>
<p>
    Tämä on kiva ja muutama käyttöympäristö käyttää dmenua
    ohjelmakäynnistimenä. Tämä on kiva ilman sumeatakin hakua. Mutta
    jos oikein halutaan kaikki irti tuosta Xmonadin
    X.A.Commands-kirjastosta, on sumeus aikalailla <i>must</i>.
</p>
<p>
    Gentoon portagessa ei dmenulle moista pätsiä tarjoilla, enkä
    viitsinyt taiteilla portagen ebuild-patch-overlayn kanssa, joten
    latasin, pätsäsin ja käänsin kotihakemistoni onkaloihin. Kirjoitin
    pienen launcherin sumean haun aktivoimiseksi ja kaikki on
    reilassa.
</p>



<pre class="example">exec /home/progo/.dmenu/bin/dmenu -i -z "$@"
</pre>


<p>
    Erillinen <code>dmenu_launch</code> on erikseen, ja siinä tuo sumeuden
    aktivoiva flagi <code>-z</code> on poissa. Näin on hyvä.
</p>
</div>

</div>

<div class="outline-4" id="outline-container-2-13-2">
<h2>Työpöytävalinta uuden Dmenun avulla</h2>
<div id="text-2-13-2" class="outline-text-4">


<p>
    Ensin tietysti kokeiltiin tätä vanhan konffin kanssa. Vielä eilen
    kovassa käytössä oli 10-ympäristöinen systeemini, jossa työpöytiä
    vaihtavat vain näppäinyhdistelmät <code>Win-d</code>, <img class="dvipng" alt="$d = 1, ..., 0$" src="http://fwwm.us/upload/blog_25bf9b96559c61fab1e1c8dc07c2fdf62c8f9e00.png" />. Tähän
    skeemaan olisikin ollut hankala lisätä uusia työpöytiä, ja
    muutenkin ideana olisi saada kestävämpi ratkaisu.
</p>
<p>
    X.A.Commands sisältää muutamia valmiiksimääriteltyjä
    "komentolistoja", joista yksi on <code>defaultCommands</code> ja toinen on
    <code>workspaceCommands</code>. Triviaali pikakokeilu osoittaa kaikki ideat
    toimiviksi; mapataan kokeeksi näppäin <code>Win-x</code>.
</p>



<pre class="example">((modm,               xK_x), defaultCommands &gt;&gt;= runCommand)
</pre>


<p>
    (Tämä pitää ujuttaa sinne Xmonad-konffin <code>keys</code>-listan jatkeeksi.
    Tavalla tai toisella, niitä on niin monia…)
</p>
<p>
    Tämä toimii upeasti. Entä pelkästään työpöytien <i>vaihtamiseen</i>
    liittyviä komentoja? Tämä on nyysitty/mukailtu X.A.Commandsien
    lähdekoodista. Tai saattoi olla oletuskonffin näppäinyhdisteistä.
    Joka tapauksessa tämä tuottaa listan pelkästään työpöytiin
    vaihtavia komentoja ja niille merkkijonoja.
</p>



<pre class="example">viewWorkspaceCommands :: X [(String, X ())]
viewWorkspaceCommands = asks (workspaces . config) &gt;&gt;= \spaces -&gt; return
                            [((m ++ " " ++ show i), windows $ f i)
                                | i &lt;- spaces
                                , (f, m) &lt;- [(W.greedyView, "view")] ]
</pre>


<p>
    Vastaavasti purkkasin ikkunoita siirtävän version. Vaihdetaan vain
    funktio <code>W.greedyView</code> funktioksi <code>W.shift</code>. Ja nämä mappasin näppäimelle
    <code>Win-f</code> ja <code>Win-S-f</code> nyt toistaiseksi:
</p>



<pre class="example">((modm,               xK_f), viewWorkspaceCommands &gt;&gt;= runCommand)
((modm .|. shiftMask, xK_f), moveWorkspaceCommands &gt;&gt;= runCommand)
</pre>


<p>    
    Ja yllätyksekseni toimii moitteetta! Nyt homma toimii siis
    kiinteän työpöytälistauksen kanssa, eli kamalasti etua ei vielä
    tässä ole. Mutta odotapas kun työpöytiä on kymmenen sijasta 100…
</p>
</div>

</div>

<div class="outline-4" id="outline-container-2-13-3">
<h2>Dynaamiset työpöydät Xmonadissa</h2>
<div id="text-2-13-3" class="outline-text-4">


<p>
    Xmonadin dynaamiset työpöydät on tehtävissä monella, monella
    tavalla. Minä tein nyt sillä tavalla, että hyödynnän työpöytiä
    uudelleennimeävää kirjastoa, <a href="http://hackage.haskell.org/package/xmonad-contrib-bluetilebranch-0.9.1.4/docs/XMonad-Actions-WorkspaceNames.html">X.A.WorkspaceNames</a>:ia.
</p>
<p>
    Luon nyt oletuksena 99 työpöytää triviaalilla nimeämisellä.
    Luulisipa riittävän!
</p>



<pre class="example">myWorkspaces = map show [1 .. 99 :: Int]
</pre>


<p>
    Tietysti tämä ei ole teknisesti ottaen dynaamista nähnytkään,
    koska kaikki työpöydät on luotu Xmonadin käynnistyessä. Idea on
    kuitenkin ihan kelpo.
</p>
<p>
    Sitten meidän pitää saada nimetä työpöytiä haluamaksemme. Se
    WorkspaceNames-kirjasto tulee tässä apuun. Siihen ei tarvitse
    muuta kuin seurata kirjaston dokumentaation ohjeita ja tehdä
    sopiva näppäimistömappaus <code>renameWorkspace</code>-funktiolle. Laitoin
    omassa konffissani sen nyt <code>Win-s</code>:n taakse.
</p>
<p>
    Nyt uudet työpöydät näkyvät oikein statuspalkissa (Xmobar
    minulla), mutta eivät pirskattilainen näy tuoreelti
    konffaamassamme dmenussa. Tarvitaan hieman voitelua ja
    WorkspaceNamesiin kuuluvaa funktiota <code>getWorkspaceNames</code>.
    Kirjoitetaan aiemmin määritelty <code>viewWorkspaceCommands</code> uudestaan:
</p>



<pre class="example">type NamedAction = String -&gt; WindowSet -&gt; WindowSet

doWSCommands :: NamedAction -&gt; String -&gt; X [(String, X ())]
doWSCommands action string = do
  spaces &lt;- asks (workspaces . config)
  wsNames &lt;- getWorkspaceNames                            -- (1)
  return [((m ++ " " ++ show (wsNames i)), windows $ f i)
         | i &lt;- spaces
         , (f, m) &lt;- [(action, string)] ]

viewWorkspaceCommands = doWSCommands W.greedyView "view"
moveWorkspaceCommands = doWSCommands W.shift      "move"
</pre>


<p>
    Taikasana on <code>(1)</code>:llä merkitty monadisovellus, joka tuottaa
    meille sopivan funktion työpöytäolioista niiden "dynaamisiin"
    nimiin.
</p>
<p>
    Ja kaikki tuntuu upeasti toimivan. Nyt minulla on kymmenen
    ensimmäistä työpöytää edelleen nopeiden pikanäppien takana ja
    loputkin ovat saatavilla dmenun kautta. Ilmeisesti nimet säilyvät
    myös Xmonadin uudelleenkäynnistysten yli, vaikka se ei ollut
    prioriteetti. Olen yllättynyt erityisesti omista
    hakkailutaidoistani. Ilmeisesti Clojuren kautta alkaa viimein
    tarttua jotain oikeata funktionaalista osaamista.
</p>
</div>

</div>

<div class="outline-4" id="outline-container-2-13-4">
<h2>Jatkokehittelyä</h2>
<div id="text-2-13-4" class="outline-text-4">


<p>
    Tämä on siis nykytilanne. Mitä parannuksia systeemi saattaisi
    vaatia?
</p>
<ul>
<li>Työpöytien swappaus, eli kaikkien ikkunoiden siirtäminen
      kerralla työtilasta toiseen voisi olla paikallaan, jos haluan
      varata jonkun "nopean" pöydän (numero alle 10) jollekin
      tuoreelle projektille.

<p>
      WorkspaceNames saattoi tarjota jotain sellaista, mutta pitää nyt
      tutkia.
</p></li>
<li>Dmenun listauksessa on nyt aina 99 työpöytää, oli niillä nimi
      tai täytettä tai ei. Numero niillä on aina, mutta vähän rumalta
      voi näyttää. Voisikohan niitä piilottaa jollain ehdolla siten,
      että niihin pääsisi kyllä tarvittaessa käsiksi, mutta ei
      tarvitsisi pikavalinnassa näkyä.
</li>
</ul>


</div>

</div>

<div class="outline-4" id="outline-container-2-13-5">
<h2>Versiohallinta voittoon</h2>
<div id="text-2-13-5" class="outline-text-4">


<p>
    Tämä on ollut lisäksi hyvä showcase gitille. Muutamia
    kuukausia/vuosia sitten kun ensimmäistä kertaa tarkastelin
    dynaamisia pöytiä, laitoin <code>xmonad.hs</code>:n git-repoksi ja kokeilin
    toisessa haarassa noita juttuja. Eihän niistä tullut oikein
    mitään. Onneksi toimiva peruskonffi oli vain haaranvaihdon takana.
</p>
<p>
    Nyt sitten oli mukava palata vanhaan haaraan, yhdistää päähaarassa
    tapahtuneet pikkumuutokset ja siistimiset ja konffata viimein koko
    roska kuntoon. Ehkäpä haara <code>dynamicws</code> saa nyt siirtyä laitumille
    ja mergaan koko toiminnallisuuden <code>masteriin</code>.
</p></div>
</div>

</div><div id="disqus_thread"></div>

<script type="text/javascript">
    // :sb__ stuff is replaced in clojure
    var disqus_shortname = 'progim';
    var disqus_identifier = '20131114_1253';

    (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] ||
         document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the <a
href="http://disqus.com/?ref_noscript">comments powered by
Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by
<span class="logo-disqus">Disqus</span></a>
</div></body></html>